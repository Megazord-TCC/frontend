<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Dashboard de portfólio</h1>
  </div>
  <div *ngIf="hasPortfolio" class="dashboard-content">
    <!-- Portfolio Selector -->
    <div class="portfolio-selector">

      <span>Portfólio:</span>
      <select [(ngModel)]="selectedPortfolioId" (change)="onPortfolioChange(selectedPortfolioId)">
        <option *ngFor="let portfolio of portfolios" [value]="portfolio.id">{{portfolio.name}}</option>
      </select>
      <button *ngIf="authService.getAuthorizedPageTypesByRole().includes(pageType.DASHBOARD)"
        class="add-portfolio-btn"
        (click)="openPortfolio(selectedPortfolioId)">
        Acessar portfólio
      </button>

    </div>
    <div class="format-selector">

      <span>Formato:</span>
      <select [(ngModel)]="selectedFormatry" (change)="onPortfolioChange(selectedPortfolioId)">
        <option *ngFor="let format of availableFormats" [value]="format">{{format}}</option>
      </select>
      <button 
        class="add-format-btn"
        (click)="downloadFile(selectedFormatry)">
        Extrair relatório
      </button>

    </div>

    <!-- Metrics Cards -->
    <div class="metrics-grid">
      <app-card class="metric-card">
        <div class="metric-content">
          <app-svg-icon
          class="nav-icon"
          [path]="'assets/icon/calendario_vetor.svg'"
          [size]="24">
        </app-svg-icon>
        <div class="metric-info-container">
          <div class="metric-title-row">
            <p class="metric-title">{{getPortfolioStatusEnumToText(portfolioDetails?.status)}}</p>
            <div class="metric-indicator" [class]="'indicator-' + portfolioDetails?.budgetHealth" ></div>
          </div>
          <p class="metric-subtitle">Status progresso</p>
        </div>
      </div>
    </app-card>
    <app-card class="metric-card">
      <div class="metric-content">
        <app-svg-icon
        class="nav-icon"
        [path]="'assets/icon/paid_vetor.svg'"
            [size]="24">
          </app-svg-icon>
          <div class="metric-info-container">
            <div class="metric-title-row">
              <p class="metric-title">{{getPortfolioHealthEnumToText(portfolioDetails?.budgetHealth)}}</p>
              <div class="metric-indicator" [class]="'indicator-' + portfolioDetails?.budgetHealth" ></div>
            </div>
            <p class="metric-subtitle">Status custo</p>
          </div>
        </div>
      </app-card>
      <app-card class="metric-card">
        <div class="metric-content">
          <app-svg-icon
          class="nav-icon"
            [path]="'assets/icon/estrategia_vetor.svg'"
            [size]="24">
          </app-svg-icon>
          <div class="metric-info-container">
            <div class="metric-title-row">
              <p class="metric-title">{{portfolioDetails?.strategy?.name || 'Sem estratégia definida'}}</p>
            </div>
            <p class="metric-subtitle">Estratégia</p>
          </div>
        </div>
      </app-card>
      <app-card class="metric-card">
        <div class="metric-content">
          <app-svg-icon
          class="nav-icon"
          [path]="'assets/icon/porco_vetor.svg'"
          [size]="24">
          </app-svg-icon>
          <div class="metric-info-container">
            <div class="metric-title-row">
              <p class="metric-title">{{portfolioDetails?.budget | currency:'BRL':'symbol':'1.2-2'}}</p>
            </div>
            <p class="metric-subtitle">Orçamento</p>
          </div>
        </div>
      </app-card>
      <app-card class="metric-card" *ngFor="let responsavel of responsaveis">
        <div class="metric-content" >
          <app-svg-icon
          class="nav-icon"
          [path]="'assets/icon/user_vetor.svg'"
          [size]="24">
          </app-svg-icon>
          <div class="metric-info-container">
            <div class="metric-title-row">
              <!-- <p class="metric-title">{{portfolioDetails?.owners[0]?.name}}</p> -->
              <p class="metric-title">{{responsavel.name}}</p>
            </div>
            <p class="metric-subtitle">Responsável</p>
          </div>
        </div>
      </app-card>
      <app-card class="metric-card" *ngIf="!responsaveis || responsaveis.length === 0">
        <div class="metric-content" >
          <app-svg-icon
          class="nav-icon"
          [path]="'assets/icon/user_vetor.svg'"
          [size]="24">
          </app-svg-icon>
          <div class="metric-info-container">
            <div class="metric-title-row">
              <!-- <p class="metric-title">{{portfolioDetails?.owners[0]?.name}}</p> -->
              <p class="metric-title">Sem responsáveis</p>
            </div>
            <p class="metric-subtitle">Responsável</p>
          </div>
        </div>
      </app-card>

    </div>

    <!-- Expandable Sections -->
    <app-card class="expandable-section">
      <button class="section-header" (click)="toggleSection('progress')">
        <div class="section-title" [class.expanded]="isSectionExpanded('progress')">
          <app-svg-icon
            class="nav-icon"
            [path]="isSectionExpanded('progress') ? 'assets/icon/setaBaixo_vetor.svg' : 'assets/icon/seta_vetor.svg'"
            [size]="14">
          </app-svg-icon>
          <span>Progresso do portfólio ({{getPortfolioProgress()}}%)</span>
        </div>
      </button>
      <div class="section-content" *ngIf="isSectionExpanded('progress')">
         <div  class="progress-item" *ngIf="!projetos || projetos.length === 0">
          <p>Nenhum projeto encontrado.</p>
        </div>
        <div class="progress-item" *ngFor="let projeto of projetos">
          <span>{{projeto.name}} ({{projeto.percentComplete | number:'1.0-0'}}%)</span>
          <app-progress [value]="projeto.percentComplete"></app-progress>
        </div>
      </div>
    </app-card>

    <!-- Risk Tracking -->
    <app-card class="expandable-section">
      <button class="section-header" (click)="toggleSection('risks')">
        <div class="section-title" [class.expanded]="isSectionExpanded('risks')">
          <app-svg-icon
            class="nav-icon"
            [path]="isSectionExpanded('risks') ? 'assets/icon/setaBaixo_vetor.svg' : 'assets/icon/seta_vetor.svg'"
            [size]="14">
          </app-svg-icon>
          <span>Acompanhamento dos 3 maiores riscos</span>
          <app-badge class="risk-badge">4 ocorrências</app-badge>
        </div>
      </button>
      <div class="section-content" *ngIf="isSectionExpanded('risks')">
        <div  class="table-container" *ngIf="!risks || risks.length === 0">
          <p>Nenhum risco encontrado.</p>
        </div>
        <div class="table-container" *ngIf="risks && risks.length > 0">
          <table class="risks-table">
            <thead>
              <tr>
                <th>Código</th>
                <th>Risco</th>
                <th>Probabilidade</th>
                <th>Impacto</th>
                <th>Severidade</th>
                <th>Ocorrências resolvidas</th>
                <th>Ocorrências não resolvidas</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let risk of risks">
                <td>{{risk.id}}</td>
                <td class="risk-name">{{risk.name}}</td>
                <td>{{getRiskSeverityEnumToText(risk.probability)}}</td>
                <td>{{getRiskSeverityEnumToText(risk.impact)}}</td>
                <td>{{risk.severity}}</td>
                <td [class.text-red]="getOccurrencesSolvedCount(risk) > 3">{{getOccurrencesSolvedCount(risk)}}</td>
                <td [class.text-red]="getOccurrencesNotSolvedCount(risk) > 1">{{getOccurrencesNotSolvedCount(risk)}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </app-card>

    <!-- Objectives -->
    <app-card class="expandable-section">
      <button class="section-header" (click)="toggleSection('objectives')">
        <div class="section-title" [class.expanded]="isSectionExpanded('objectives')">
          <app-svg-icon
            class="nav-icon"
            [path]="isSectionExpanded('objectives') ? 'assets/icon/setaBaixo_vetor.svg' : 'assets/icon/seta_vetor.svg'"
            [size]="14">
          </app-svg-icon>
          <span>Objetivos</span>
        </div>
      </button>
      <div class="section-content" *ngIf="isSectionExpanded('objectives')">
        <div  class="objectives-list" *ngIf="!objetivos || objetivos.length === 0">
          <p>Nenhum objetivo encontrado.</p>
        </div>
        <div class="objectives-list" *ngIf="objetivos && objetivos.length > 0">
          <div class="objective-item" *ngFor="let objective of objetivos">
            <app-svg-icon
              class="nav-icon"
              [path]="'assets/icon/p_vetor.svg'"
              [size]="18">
            </app-svg-icon>
            <div class="objective-info">
              <p class="objective-name">{{objective.name}}</p>
              <p class="objective-description">{{objective.description}}</p>
            </div>
          </div>
        </div>
      </div>
    </app-card>

    <div class="charts-grid">
      <app-card class="chart-card">
        <h3>Custo</h3>
        <div class="chart-container">
          <canvas #costChart></canvas>
        </div>
      </app-card>

      <app-card class="chart-card">
        <h3>Retorno vinculado a estratégia</h3>
        <div class="chart-container">
          <canvas #projectBubbleChart></canvas>
        </div>
        <div class="chart-description">
          <p>O tamanho da bolha indica o ROI. Bolhas brancas indicam ROI negativo.</p>
        </div>
      </app-card>

      <app-card class="chart-card">
        <h3>Riscos com maior severidade</h3>
        <div class="chart-container">
          <canvas #riskBubbleChart></canvas>
        </div>
        <div class="chart-description">
          <p>O tamanho da bolha representa a severidade do risco.</p>
        </div>
      </app-card>
    </div>
  </div>
  <div *ngIf="!hasPortfolio" class="dashboard-content">
      Não há portfólios cadastrados.
  </div>
</div>
